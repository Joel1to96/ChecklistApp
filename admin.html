<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Meta etiquetas esenciales -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración del Restaurante</title>
    
    <!-- Incorporar Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet' />
    
    <!-- Estilos personalizados -->
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f0f0f0;
            padding-bottom: 60px; /* Espacio para la barra de navegación */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1, h2 { 
            color: #2c3e50; 
        }
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none; /* Ocultar todas las secciones por defecto */
        }
        .section.active {
            display: block; /* Mostrar solo la sección activa */
        }
        .task-input, .shift-input, .announcement-input { 
            display: flex; 
            margin-bottom: 10px; 
            gap: 10px;
        }
        .announcement-input {
            flex-direction: column;
        }
        .announcement-input textarea {
            height: 100px;
            resize: vertical;
        }
        .btn-custom {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-custom:hover {
            background-color: #2980b9;
        }
        .task-list, .shift-list, .announcement-list {
            list-style-type: none;
            padding: 0;
        }
        .task-item, .shift-item, .announcement-item {
            background-color: #f9f9f9;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .announcement-item {
            flex-direction: column;
            align-items: flex-start;
        }
        .announcement-item h3 {
            margin-top: 0;
        }
        .logout-button {
            background-color: #e74c3c;
        }
        .logout-button:hover {
            background-color: #c0392b;
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #2c3e50;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }
        .nav-item {
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            position: relative;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background-color: #34495e;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            display: none;
        }
        #calendar {
            height: 600px;
            margin-bottom: 20px;
        }
        .fc-event {
            border: none !important;
            padding: 2px 5px !important;
        }
        .fc-daygrid-event-dot {
            display: none !important;
        }
        /* Estilos para los botones de selección de días */
        .day-toggle-buttons {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        .day-toggle-buttons button {
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #ecf0f1;
            color: #2c3e50;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .day-toggle-buttons button.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        /* Estilos para ocultar y mostrar elementos */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Área de notificaciones -->
        <div id="notification" class="alert" style="display: none;"></div>

        <div class="header">
            <h1>Administración del Restaurante</h1>
            <button id="logoutButton" class="logout-button btn btn-danger">Cerrar Sesión</button>
        </div>

        <!-- Sección de Anuncios -->
        <div id="announcementsSection" class="section active">
            <h2>Gestión de Anuncios</h2>
            <div class="announcement-input">
                <input type="text" id="announcementTitle" placeholder="Título del anuncio">
                <textarea id="announcementContent" placeholder="Contenido del anuncio"></textarea>
                <button id="addAnnouncementButton" class="btn-custom">Publicar Anuncio</button>
            </div>
            <ul id="announcementList" class="announcement-list"></ul>
        </div>

        <!-- Sección de Tareas -->
        <div id="tasksSection" class="section">
            <h2>Gestión de Tareas</h2>
            <div class="task-input">
                <input type="text" id="newTask" placeholder="Nueva tarea">
                <select id="assignTo">
                    <option value="">Asignar a...</option>
                    <option value="Cocinero">Cocinero</option>
                    <option value="Mesero">Mesero</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Gerente">Gerente</option>
                </select>
                <select id="assignBy">
                    <option value="dayOfWeek">Día de la Semana</option>
                    <option value="date">Fecha Específica</option>
                </select>
            </div>
            <div id="dayOfWeekSelection" class="form-group">
                <label>Días de la Semana:</label>
                <div class="day-toggle-buttons">
                    <button type="button" data-day="Lunes">Lunes</button>
                    <button type="button" data-day="Martes">Martes</button>
                    <button type="button" data-day="Miércoles">Miércoles</button>
                    <button type="button" data-day="Jueves">Jueves</button>
                    <button type="button" data-day="Viernes">Viernes</button>
                    <button type="button" data-day="Sábado">Sábado</button>
                    <button type="button" data-day="Domingo">Domingo</button>
                </div>
                <!-- Nuevo checkbox para asignar a todos los días -->
                <div class="form-group mt-2">
                    <input type="checkbox" id="assignAllDays">
                    <label for="assignAllDays">Asignar a todos los días</label>
                </div>
            </div>
            <div id="dateSelection" class="form-group hidden">
                <label for="taskDate">Fecha Específica:</label>
                <input type="date" id="taskDate">
            </div>
            <button id="addTaskButton" class="btn-custom">Añadir Tarea</button>
            <ul id="taskList" class="task-list"></ul>
            <!-- Formulario para editar tarea -->
            <div id="editTaskSection" style="display: none;">
                <h2>Editar Tarea</h2>
                <input type="text" id="editTaskName" placeholder="Nombre de la tarea">
                <select id="editAssignTo">
                    <option value="">Asignar a...</option>
                    <option value="Cocinero">Cocinero</option>
                    <option value="Mesero">Mesero</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Gerente">Gerente</option>
                </select>
                <select id="editAssignBy">
                    <option value="dayOfWeek">Día de la Semana</option>
                    <option value="date">Fecha Específica</option>
                </select>
                <div id="editDayOfWeekSelection" class="form-group">
                    <label>Días de la Semana:</label>
                    <div class="day-toggle-buttons">
                        <button type="button" data-day="Lunes">Lunes</button>
                        <button type="button" data-day="Martes">Martes</button>
                        <button type="button" data-day="Miércoles">Miércoles</button>
                        <button type="button" data-day="Jueves">Jueves</button>
                        <button type="button" data-day="Viernes">Viernes</button>
                        <button type="button" data-day="Sábado">Sábado</button>
                        <button type="button" data-day="Domingo">Domingo</button>
                    </div>
                </div>
                <div id="editDateSelection" class="form-group hidden">
                    <label for="editTaskDate">Fecha Específica:</label>
                    <input type="date" id="editTaskDate">
                </div>
                <button id="updateTaskButton" class="btn-custom">Actualizar Tarea</button>
                <button id="cancelTaskEditButton" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>

        <!-- Sección de Turnos -->
        <div id="shiftsSection" class="section">
            <h2>Gestión de Turnos</h2>
            <div id="calendar"></div>
            <div class="shift-input">
                <input type="date" id="shiftDate">
                <input type="time" id="shiftStart">
                <input type="time" id="shiftEnd">
                <select id="shiftEmployee">
                    <option value="">Asignar a...</option>
                    <option value="Cocinero">Cocinero</option>
                    <option value="Mesero">Mesero</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Gerente">Gerente</option>
                </select>
                <button id="addShiftButton" class="btn-custom">Añadir Turno</button>
            </div>
        </div>

        <!-- Sección de Usuarios -->
        <div id="usersSection" class="section">
            <h2>Gestión de Usuarios</h2>
            <div class="user-input">
                <input type="text" id="userName" placeholder="Nombre del usuario">
                <input type="password" id="userPassword" placeholder="Contraseña">
                <select id="userRole">
                    <option value="admin">Admin</option>
                    <option value="mesero">Mesero</option>
                    <option value="cocinero">Cocinero</option>
                    <option value="limpieza">Limpieza</option>
                    <option value="gerente">Gerente</option>
                </select>
                <button id="addUserButton" class="btn-custom">Crear Usuario</button>
            </div>
            <ul id="userList"></ul>
        </div>

        <!-- Sección de Historial de Tareas -->
        <div id="taskHistorySection" class="section">
            <h2>Historial de Tareas</h2>
            <div class="form-group">
                <label for="workerSelect">Selecciona un trabajador:</label>
                <select id="workerSelect" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="startDate">Fecha de inicio:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="form-group">
                <label for="endDate">Fecha de fin:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <button id="loadTaskHistoryButton" class="btn-custom">Cargar Historial</button>
            <button id="downloadTaskHistoryButton" class="btn btn-success" style="display: none;">Descargar Historial</button>
            <div id="taskHistoryResults" style="margin-top: 20px;"></div>
        </div>

    </div>

    <!-- Formulario para editar usuario -->
    <div id="editUserSection" style="display: none;">
        <h2>Editar Usuario</h2>
        <input type="text" id="editUserName" placeholder="Nombre del usuario">
        <input type="password" id="editUserPassword" placeholder="Contraseña">
        <select id="editUserRole">
            <option value="admin">Admin</option>
            <option value="mesero">Mesero</option>
            <option value="cocinero">Cocinero</option>
            <option value="limpieza">Limpieza</option>
            <option value="gerente">Gerente</option>
        </select>
        <button id="updateUserButton" class="btn-custom">Actualizar Usuario</button>
        <button id="cancelUserEditButton" class="btn btn-secondary">Cancelar</button>
    </div>

    <!-- Barra de navegación -->
    <nav class="nav-bar">
        <a href="#" class="nav-item active" data-section="announcementsSection">
            Anuncios
            <span class="notification-badge" id="announcementsBadge"></span>
        </a>
        <a href="#" class="nav-item" data-section="tasksSection">
            Tareas
            <span class="notification-badge" id="tasksBadge"></span>
        </a>
        <a href="#" class="nav-item" data-section="shiftsSection">
            Turnos
            <span class="notification-badge" id="shiftsBadge"></span>
        </a>
        <a href="#" class="nav-item" data-section="usersSection">
            Usuarios
            <span class="notification-badge" id="usersBadge"></span>
        </a>
        <a href="#" class="nav-item" data-section="taskHistorySection">
            Historial de Tareas
        </a>
    </nav>

    <!-- Scripts de Firebase y JavaScript -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/locales/es.js'></script>

    <!-- Librería Day.js para manejo de fechas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.8.21/dayjs.min.js"></script>

    <!-- Bootstrap JS y jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Código JavaScript -->
    <script>
    (function() {
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD2Ro-aX_BvF4FUQDYLqNOapc_0CZIh5Qg",
            authDomain: "reastauranteapp.firebaseapp.com",
            projectId: "reastauranteapp",
            storageBucket: "reastauranteapp.appspot.com",
            messagingSenderId: "15166663435",
            appId: "1:15166663435:web:dbd9dadcb13e83a904500e",
            measurementId: "G-H1N33YWYJ0"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Inicializar Firestore
        const db = firebase.firestore();

        // Variables locales
        let tasks = [];
        let shifts = [];
        let announcements = [];
        let calendar;
        let selectedDays = [];
        let currentUserId = null;
        let currentTaskId = null;
        let taskHistoryData = []; // Variable para almacenar los datos del historial

        // Función para inicializar el calendario
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                locale: 'es',
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día'
                },
                events: [],
                eventClick: function(info) {
                    if (confirm(`¿Deseas eliminar el turno de ${info.event.title}?`)) {
                        deleteShift(info.event.id);
                        info.event.remove();
                    }
                },
                height: 'auto',
                eventTimeFormat: {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                },
                displayEventTime: false,
                displayEventEnd: false,
                eventDisplay: 'block'
            });
            calendar.render();
            loadShifts(); // Cargar los turnos al iniciar
            loadWorkerOptions(); // Cargar la lista de trabajadores al iniciar
        });

        // Función para eliminar un turno
        function deleteShift(id) {
            db.collection("shifts").doc(id).delete().then(() => {
                console.log("Turno eliminado correctamente");
                loadShifts();
            }).catch((error) => {
                console.error("Error al eliminar turno: ", error);
            });
        }

        // Función para mostrar notificaciones
        function showNotification(message, type='success') {
            const notification = document.getElementById('notification');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Evento para mostrar/ocultar las opciones de asignación
        document.getElementById('assignBy').addEventListener('change', function() {
            const assignBy = this.value;
            if (assignBy === 'dayOfWeek') {
                document.getElementById('dayOfWeekSelection').classList.remove('hidden');
                document.getElementById('dateSelection').classList.add('hidden');
            } else if (assignBy === 'date') {
                document.getElementById('dayOfWeekSelection').classList.add('hidden');
                document.getElementById('dateSelection').classList.remove('hidden');
            }
        });

        // Evento para los botones de días utilizando delegación de eventos
        document.querySelector('#dayOfWeekSelection .day-toggle-buttons').addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const day = button.getAttribute('data-day');
                if (selectedDays.includes(day)) {
                    selectedDays = selectedDays.filter(d => d !== day);
                    button.classList.remove('active');
                } else {
                    selectedDays.push(day);
                    button.classList.add('active');
                }
                console.log('Días seleccionados:', selectedDays);
            }
        });

        // Eventos para los botones de navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId, this);
            });
        });

        // Función para mostrar la sección correspondiente y actualizar la navegación
        function showSection(sectionId, clickedItem) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            // Mostrar la sección seleccionada
            document.getElementById(sectionId).classList.add('active');

            // Actualizar la navegación activa
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            clickedItem.classList.add('active');

            // Si es la sección de turnos, renderizar el calendario
            if (sectionId === 'shiftsSection') {
                setTimeout(() => {
                    calendar.render();
                }, 0);
            }
        }

        // Funciones para cargar datos desde Firestore utilizando onSnapshot()
        function loadTasks() {
            db.collection("tasks").orderBy("createdAt", "desc").onSnapshot((querySnapshot) => {
                tasks = [];
            querySnapshot.forEach((doc) => {
                tasks.push({ id: doc.id, ...doc.data() });
        });
        console.log('Tareas cargadas:', tasks);
        renderTasks();
    }, (error) => {
        console.error('Error al cargar tareas:', error);
    });
}


        // Función para cargar los turnos
        function loadShifts() {
            db.collection("shifts").get().then((querySnapshot) => {
                shifts = [];
                querySnapshot.forEach((doc) => {
                    shifts.push({ id: doc.id, ...doc.data() });
                });
                calendar.removeAllEvents();
                calendar.addEventSource(getShiftEvents());
            });
        }

        function loadAnnouncements() {
            db.collection("announcements").orderBy("date", "desc").limit(50).onSnapshot((querySnapshot) => {
                announcements = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    announcements.push({ 
                        id: doc.id, 
                        ...data,
                        date: data.date ? data.date : firebase.firestore.Timestamp.now()
                    });
                });
                renderAnnouncements();
            });
        }

        function loadUsers() {
            db.collection("users").orderBy("createdAt", "desc").limit(50).onSnapshot((querySnapshot) => {
                renderUserList(querySnapshot);
            });
        }

        // Función para cargar la lista de trabajadores en los select correspondientes
function loadWorkerOptions() {
    const shiftEmployeeSelect = document.getElementById('shiftEmployee');
    const workerSelect = document.getElementById('workerSelect'); // Añadimos este elemento
    
    // Limpiamos los select antes de llenarlos
    shiftEmployeeSelect.innerHTML = '<option value="">Asignar a...</option>';
    workerSelect.innerHTML = '<option value="">Selecciona un trabajador...</option>';

    db.collection('users').get()
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.role !== 'admin') { // Excluir administradores
                    // Llenar el select de empleados para los turnos
                    const optionShift = document.createElement('option');
                    optionShift.value = userData.name;
                    optionShift.textContent = `${userData.name} (${userData.role})`;
                    shiftEmployeeSelect.appendChild(optionShift);

                    // Llenar el select de trabajadores para el historial de tareas
                    const optionWorker = document.createElement('option');
                    optionWorker.value = userData.name;
                    optionWorker.textContent = `${userData.name} (${userData.role})`;
                    workerSelect.appendChild(optionWorker);
                }
            });
        })
        .catch((error) => {
            console.error('Error al cargar los trabajadores:', error);
        });
}

        // Modificar la función getShiftEvents() para reflejar los cambios
        function getShiftEvents() {
            return shifts.map(shift => ({
                id: shift.id,
                title: shift.employee ? `${shift.employee}: ${shift.start} - ${shift.end}` : 'Turno sin asignar',
                start: shift.date && shift.start ? `${shift.date}T${shift.start}` : null,
                end: shift.date && shift.end ? `${shift.date}T${shift.end}` : null,
                color: getRandomColor(shift.employee),
                allDay: false,
                display: 'block'
            })).filter(event => event.start && event.end); // Filtra eventos sin fechas válidas
        }

        // Función para generar un color basado en una cadena
        function getRandomColor(str) {
            if (!str) return '#000000';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        // Función para añadir una tarea
        function addTask() {
            const newTaskInput = document.getElementById('newTask');
            const assignToSelect = document.getElementById('assignTo');
            const assignBySelect = document.getElementById('assignBy');
            const text = newTaskInput.value.trim();
            const assignedTo = assignToSelect.value;
            const assignBy = assignBySelect.value;
            let assignedDate = null;

            if (assignBy === 'dayOfWeek') {
                // Nuevo: Verificar si el checkbox "Asignar a todos los días" está marcado
                if (document.getElementById('assignAllDays').checked) {
                    selectedDays = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                } else {
                    if (selectedDays.length === 0) {
                        showNotification('Por favor, selecciona al menos un día de la semana.', 'danger');
                        return;
                    }
                }
            } else if (assignBy === 'date') {
                assignedDate = document.getElementById('taskDate').value;
                if (!assignedDate) {
                    showNotification('Por favor, selecciona una fecha específica.', 'danger');
                    return;
                }
            }

            if (text && assignedTo) {
                db.collection("tasks").add({
                    text: text,
                    assignedTo: assignedTo,
                    completed: false,
                    createdAt: firebase.firestore.Timestamp.now(),
                    assignBy: assignBy,
                    assignedDays: selectedDays,
                    assignedDate: assignedDate
                })
                .then((docRef) => {
                    console.log("Tarea añadida con ID: ", docRef.id);
                    resetTaskInputs();
                    showNotification('Tarea añadida exitosamente');
                })
                .catch((error) => {
                    console.error("Error al añadir tarea: ", error);
                    showNotification('Error al añadir tarea', 'danger');
                });
            } else {
                showNotification('Por favor, completa todos los campos requeridos.', 'danger');
            }
        }

        // Función para resetear los campos de tarea
        function resetTaskInputs() {
            document.getElementById('newTask').value = '';
            document.getElementById('assignTo').value = '';
            document.getElementById('assignBy').value = 'dayOfWeek';
            document.getElementById('dayOfWeekSelection').classList.remove('hidden');
            document.getElementById('dateSelection').classList.add('hidden');
            selectedDays = [];
            document.querySelectorAll('.day-toggle-buttons button').forEach(button => button.classList.remove('active'));
            document.getElementById('taskDate').value = '';
            // Nuevo: Desmarcar el checkbox "Asignar a todos los días"
            document.getElementById('assignAllDays').checked = false;
        }

        // Función para renderizar las tareas
        function renderTasks() {
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = '';
    tasks.forEach((task) => {
        const li = document.createElement('li');
        li.className = 'task-item';
        let assignDetails = '';
        if (task.assignBy === 'dayOfWeek') {
            assignDetails = `Días: ${task.assignedDays ? task.assignedDays.join(', ') : ''}`;
        } else if (task.assignBy === 'date') {
            assignDetails = `Fecha: ${task.assignedDate || ''}`;
        }
        li.innerHTML = `
            <span>${task.text} - Asignado a: ${task.assignedTo} (${assignDetails})</span>
            <div>
                <button class="btn btn-sm btn-primary edit-task-button" data-id="${task.id}">Editar</button>
                <button class="btn btn-sm btn-danger delete-task-button" data-id="${task.id}">Eliminar</button>
            </div>
        `;
        taskList.appendChild(li);
    });
}


        // Eventos para los botones de tareas (Delegación de eventos)
        document.getElementById('taskList').addEventListener('click', function(event) {
    if (event.target.classList.contains('edit-task-button')) {
        const taskId = event.target.getAttribute('data-id');
        editTask(taskId);
    } else if (event.target.classList.contains('delete-task-button')) {
        const taskId = event.target.getAttribute('data-id');
        deleteTask(taskId);
    }
});

        // Función para eliminar una tarea
        function deleteTask(id) {
            db.collection("tasks").doc(id).delete().then(() => {
                console.log("Tarea eliminada correctamente");
                showNotification('Tarea eliminada');
            }).catch((error) => {
                console.error("Error al eliminar tarea: ", error);
                showNotification('Error al eliminar tarea', 'danger');
            });
        }

        // Función para editar una tarea
        function editTask(taskId) {
            currentTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('editTaskName').value = task.text;
                document.getElementById('editAssignTo').value = task.assignedTo;
                document.getElementById('editAssignBy').value = task.assignBy;
                if (task.assignBy === 'dayOfWeek') {
                    document.getElementById('editDayOfWeekSelection').classList.remove('hidden');
                    document.getElementById('editDateSelection').classList.add('hidden');
                    // Actualizar botones de días
                    selectedDays = task.assignedDays || [];
                    document.querySelectorAll('#editDayOfWeekSelection .day-toggle-buttons button').forEach(button => {
                        const day = button.getAttribute('data-day');
                        if (selectedDays.includes(day)) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                    });
                } else if (task.assignBy === 'date') {
                    document.getElementById('editDayOfWeekSelection').classList.add('hidden');
                    document.getElementById('editDateSelection').classList.remove('hidden');
                    document.getElementById('editTaskDate').value = task.assignedDate;
                }
                document.getElementById('editTaskSection').style.display = 'block';
            }
        }

        // Función para actualizar una tarea
        function updateTask() {
            const taskName = document.getElementById('editTaskName').value.trim();
            const assignedTo = document.getElementById('editAssignTo').value;
            const assignBy = document.getElementById('editAssignBy').value;
            let assignedDate = null;
            let assignedDays = [];

            if (assignBy === 'dayOfWeek') {
                document.querySelectorAll('#editDayOfWeekSelection .day-toggle-buttons button.active').forEach(button => {
                    assignedDays.push(button.getAttribute('data-day'));
                });
                if (assignedDays.length === 0) {
                    showNotification('Por favor, selecciona al menos un día de la semana.', 'danger');
                    return;
                }
            } else if (assignBy === 'date') {
                assignedDate = document.getElementById('editTaskDate').value;
                if (!assignedDate) {
                    showNotification('Por favor, selecciona una fecha específica.', 'danger');
                    return;
                }
            }

            if (taskName && assignedTo) {
                const updatedData = {
                    text: taskName,
                    assignedTo: assignedTo,
                    assignBy: assignBy,
                    assignedDays: assignedDays,
                    assignedDate: assignedDate
                };

                db.collection("tasks").doc(currentTaskId).update(updatedData).then(() => {
                    console.log("Tarea actualizada");
                    showNotification('Tarea actualizada exitosamente');
                    cancelTaskEdit();
                }).catch((error) => {
                    console.error("Error al actualizar tarea: ", error);
                    showNotification('Error al actualizar tarea', 'danger');
                });
            } else {
                showNotification('Por favor, completa todos los campos requeridos.', 'danger');
            }
        }

        // Función para cancelar la edición de tarea
        function cancelTaskEdit() {
            document.getElementById('editTaskSection').style.display = 'none';
            currentTaskId = null;
            selectedDays = [];
            document.querySelectorAll('#editDayOfWeekSelection .day-toggle-buttons button').forEach(button => button.classList.remove('active'));
        }

        // Eventos para los botones de edición de tarea
        document.getElementById('updateTaskButton').addEventListener('click', updateTask);
        document.getElementById('cancelTaskEditButton').addEventListener('click', cancelTaskEdit);

        // Evento para los botones de días en la edición de tareas
        document.querySelector('#editDayOfWeekSelection .day-toggle-buttons').addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                const button = event.target;
                const day = button.getAttribute('data-day');
                if (selectedDays.includes(day)) {
                    selectedDays = selectedDays.filter(d => d !== day);
                    button.classList.remove('active');
                } else {
                    selectedDays.push(day);
                    button.classList.add('active');
                }
                console.log('Días seleccionados (edición):', selectedDays);
            }
        });

        // Modificar la función addShift() para almacenar el nombre del trabajador
        function addShift() {
            const date = document.getElementById('shiftDate').value;
            const start = document.getElementById('shiftStart').value;
            const end = document.getElementById('shiftEnd').value;
            const employee = document.getElementById('shiftEmployee').value;

            if (date && start && end && employee) {
                db.collection("shifts").add({
                    date: date,
                    start: start,
                    end: end,
                    employee: employee, // Almacenamos el nombre del trabajador
                    createdAt: firebase.firestore.Timestamp.now()
                })
                .then((docRef) => {
                    console.log("Turno añadido con ID: ", docRef.id);
                    clearShiftInputs();
                    loadShifts();
                })
                .catch((error) => {
                    console.error("Error al añadir turno: ", error);
                });
            } else {
                alert('Por favor, completa todos los campos requeridos.');
            }
        }

        // Función para eliminar un turno
        function deleteShift(id) {
            db.collection("shifts").doc(id).delete().then(() => {
                console.log("Turno eliminado correctamente");
                loadShifts();
            }).catch((error) => {
                console.error("Error al eliminar turno: ", error);
            });
        }

        // Función para limpiar los campos de turno
        function clearShiftInputs() {
            document.getElementById('shiftDate').value = '';
            document.getElementById('shiftStart').value = '';
            document.getElementById('shiftEnd').value = '';
            document.getElementById('shiftEmployee').value = '';
        }

        // Función para renderizar los anuncios
        function renderAnnouncements() {
            const announcementList = document.getElementById('announcementList');
            announcementList.innerHTML = '';
            announcements.forEach((announcement) => {
                const li = document.createElement('li');
                li.className = 'announcement-item';
                let dateString;
                if (announcement.date && typeof announcement.date.toDate === 'function') {
                    dateString = dayjs(announcement.date.toDate()).format('DD/MM/YYYY HH:mm');
                } else if (announcement.date instanceof Date) {
                    dateString = dayjs(announcement.date).format('DD/MM/YYYY HH:mm');
                } else {
                    dateString = 'Fecha no disponible';
                }
                li.innerHTML = `
                    <h3>${announcement.title}</h3>
                    <p>${announcement.content}</p>
                    <small>${dateString}</small>
                    <button class="btn btn-sm btn-danger delete-announcement-button" data-id="${announcement.id}">Eliminar</button>
                `;
                announcementList.appendChild(li);
            });
        }

        // Eventos para los botones de anuncios
        document.getElementById('announcementList').addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-announcement-button')) {
                const announcementId = event.target.getAttribute('data-id');
                deleteAnnouncement(announcementId);
            }
        });

        // Función para añadir un anuncio
        function addAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            if (title && content) {
                db.collection("announcements").add({
                    title: title,
                    content: content,
                    date: firebase.firestore.Timestamp.now()
                })
                .then((docRef) => {
                    console.log("Anuncio añadido con ID: ", docRef.id);
                    clearAnnouncementInputs();
                    showNotification('Anuncio publicado exitosamente');
                })
                .catch((error) => {
                    console.error("Error al añadir anuncio: ", error);
                    showNotification('Error al añadir anuncio', 'danger');
                });
            } else {
                showNotification('Por favor, completa todos los campos requeridos.', 'danger');
            }
        }

        // Función para eliminar un anuncio
        function deleteAnnouncement(id) {
            db.collection("announcements").doc(id).delete().then(() => {
                console.log("Anuncio eliminado correctamente");
                showNotification('Anuncio eliminado');
            }).catch((error) => {
                console.error("Error al eliminar anuncio: ", error);
                showNotification('Error al eliminar anuncio', 'danger');
            });
        }

        // Función para limpiar los campos de anuncio
        function clearAnnouncementInputs() {
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
        }

        // Función para cerrar sesión
        function logout() {
            sessionStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Función para limpiar el almacenamiento
        function clearStorage() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los datos? Esta acción no se puede deshacer.')) {
                db.collection("tasks").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        db.collection("tasks").doc(doc.id).delete();
                    });
                });
                db.collection("shifts").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        db.collection("shifts").doc(doc.id).delete();
                    });
                });
                db.collection("announcements").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        db.collection("announcements").doc(doc.id).delete();
                    });
                });
                showNotification('Almacenamiento limpiado', 'warning');
            }
        }

        // Función para añadir un usuario
        function addUser() {
            const userName = document.getElementById('userName').value.trim();
            const userPassword = document.getElementById('userPassword').value.trim();
            const userRole = document.getElementById('userRole').value;

            if (userName && userPassword) {
                const hashedPassword = btoa(userPassword); // No recomendado para producción

                db.collection("users").add({
                    name: userName,
                    password: hashedPassword,
                    role: userRole,
                    createdAt: firebase.firestore.Timestamp.now()
                }).then(() => {
                    console.log("Usuario creado");
                    showNotification('Usuario creado exitosamente');
                }).catch((error) => {
                    console.error("Error al crear usuario: ", error);
                    showNotification('Error al crear usuario', 'danger');
                });
            } else {
                showNotification('Por favor, completa todos los campos requeridos.', 'danger');
            }
        }

        // Función para renderizar la lista de usuarios
        function renderUserList(querySnapshot) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${doc.data().name} - Rol: ${doc.data().role} 
                    <button class="btn btn-sm btn-primary edit-user-button" data-id="${doc.id}">Editar</button>
                    <button class="btn btn-sm btn-danger delete-user-button" data-id="${doc.id}">Eliminar</button>
                `;
                userList.appendChild(li);
            });
        }

        // Eventos para los botones de usuarios
        document.getElementById('userList').addEventListener('click', function(event) {
            if (event.target.classList.contains('edit-user-button')) {
                const userId = event.target.getAttribute('data-id');
                editUser(userId);
            } else if (event.target.classList.contains('delete-user-button')) {
                const userId = event.target.getAttribute('data-id');
                deleteUser(userId);
            }
        });

        // Función para editar un usuario
        function editUser(userId) {
            currentUserId = userId;
            db.collection("users").doc(userId).get().then((doc) => {
                const userData = doc.data();
                document.getElementById('editUserName').value = userData.name;
                document.getElementById('editUserPassword').value = '';
                document.getElementById('editUserRole').value = userData.role;
                document.getElementById('editUserSection').style.display = 'block';
            });
        }

        // Función para actualizar un usuario
        function updateUser() {
            const userName = document.getElementById('editUserName').value.trim();
            const userPassword = document.getElementById('editUserPassword').value.trim();
            const userRole = document.getElementById('editUserRole').value;

            const userData = {
                name: userName,
                role: userRole,
            };

            if (userPassword) {
                userData.password = btoa(userPassword);
            }

            db.collection("users").doc(currentUserId).update(userData).then(() => {
                console.log("Usuario actualizado");
                showNotification('Usuario actualizado exitosamente');
                cancelEdit();
            }).catch((error) => {
                console.error("Error al actualizar usuario: ", error);
                showNotification('Error al actualizar usuario', 'danger');
            });
        }

        // Función para cancelar la edición de usuario
        function cancelEdit() {
            document.getElementById('editUserSection').style.display = 'none';
            currentUserId = null;
        }

        // Función para eliminar un usuario
        function deleteUser(userId) {
            db.collection("users").doc(userId).delete().then(() => {
                console.log("Usuario eliminado correctamente");
                showNotification('Usuario eliminado');
            }).catch((error) => {
                console.error("Error al eliminar usuario: ", error);
                showNotification('Error al eliminar usuario', 'danger');
            });
        }

        // Función para cargar el historial de tareas
        function loadTaskHistory() {
            const workerName = document.getElementById('workerSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!workerName) {
                showNotification('Por favor, selecciona un trabajador.', 'danger');
                return;
            }
            if (!startDate || !endDate) {
                showNotification('Por favor, selecciona un rango de fechas válido.', 'danger');
                return;
            }

            const startTimestamp = firebase.firestore.Timestamp.fromDate(new Date(startDate));
            const endTimestamp = firebase.firestore.Timestamp.fromDate(new Date(endDate + 'T23:59:59'));

            db.collection('taskCompletionLogs')
                .where('userName', '==', workerName)
                .where('timestamp', '>=', startTimestamp)
                .where('timestamp', '<=', endTimestamp)
                .orderBy('timestamp', 'asc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        document.getElementById('taskHistoryResults').innerHTML = '<p>No hay registros para este trabajador en el rango de fechas seleccionado.</p>';
                        document.getElementById('downloadTaskHistoryButton').style.display = 'none';
                        taskHistoryData = []; // Limpiar datos
                        return;
                    }

                    taskHistoryData = []; // Limpiar datos
                    let html = '';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        taskHistoryData.push(data); // Almacenar datos para descargar
                        const date = data.date;
                        html += `<h3>Fecha: ${date}</h3>`;
                        html += '<h4>Tareas Completadas:</h4>';
                        if (data.completedTasks && data.completedTasks.length > 0) {
                            html += '<ul>';
                            data.completedTasks.forEach(task => {
                                html += `<li>${task.text}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += '<p>No hay tareas completadas.</p>';
                        }

                        html += '<h4>Tareas Incompletas:</h4>';
                        if (data.incompleteTasks && data.incompleteTasks.length > 0) {
                            html += '<ul>';
                            data.incompleteTasks.forEach(task => {
                                html += `<li>${task.text}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += '<p>No hay tareas incompletas.</p>';
                        }
                    });
                    document.getElementById('taskHistoryResults').innerHTML = html;
                    document.getElementById('downloadTaskHistoryButton').style.display = 'block';
                })
                .catch((error) => {
                    console.error('Error al cargar el historial de tareas:', error);
                    showNotification('Error al cargar el historial de tareas.', 'danger');
                });
        }

        // Función para descargar el historial de tareas
        function downloadTaskHistory() {
            if (taskHistoryData.length === 0) {
                showNotification('No hay datos para descargar.', 'danger');
                return;
            }

            let csvContent = 'Fecha,Tareas Completadas,Tareas Incompletas\n';

            taskHistoryData.forEach((data) => {
                const date = data.date;
                const completedTasks = data.completedTasks.map(task => task.text.replace(/"/g, '""')).join(' | ');
                const incompleteTasks = data.incompleteTasks.map(task => task.text.replace(/"/g, '""')).join(' | ');
                csvContent += `"${date}","${completedTasks}","${incompleteTasks}"\n`;
            });

            // Crear un blob y descargar
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const workerName = document.getElementById('workerSelect').value;
            const filename = `Historial_Tareas_${workerName}.csv`;

            if (navigator.msSaveBlob) { // Para IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                const link = document.createElement('a');
                if (link.download !== undefined) { // Detección de soporte
                    // Navegadores que soportan el atributo download
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }

        // Eventos para los botones principales
        document.getElementById('addTaskButton').addEventListener('click', addTask);
        document.getElementById('addShiftButton').addEventListener('click', addShift);
        document.getElementById('addAnnouncementButton').addEventListener('click', addAnnouncement);
        document.getElementById('addUserButton').addEventListener('click', addUser);
        document.getElementById('logoutButton').addEventListener('click', logout);
        document.getElementById('updateUserButton').addEventListener('click', updateUser);
        document.getElementById('cancelUserEditButton').addEventListener('click', cancelEdit);

        // Eventos para el historial de tareas
        document.getElementById('loadTaskHistoryButton').addEventListener('click', loadTaskHistory);
        document.getElementById('downloadTaskHistoryButton').addEventListener('click', downloadTaskHistory);

        // Cargar todos los datos al iniciar
        window.addEventListener('load', () => {
            loadTasks();
            loadShifts();
            loadAnnouncements();
            loadUsers();
            loadWorkerOptions(); // Cargar opciones de trabajadores para el historial
            // Mostrar solo la sección activa al cargar la página
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById('announcementsSection').classList.add('active');
        });
    })();
    </script>
</body>
</html>
